# 产品详细需求文档

## 1.1 用药管理（核心功能 / 第一阶段必须完成）

包含：计划、周期、订阅提醒、打卡/补记、药品说明。

### A) 用药计划（`plan-list` / `plan-edit` / `plan-detail`）

#### 功能点

1. **新建计划字段**：
   - 药品名称
   - 剂量
   - 服用时间（每天可多次）
   - 开始/结束日期
   - 重复周期：每日 / 每周特定几天

2. **计划状态与校验规则（前后端一致）**：
   - `name` 必填，长度 1–50
   - `dosage` 必填（如“1片/10毫升”）
   - `times` 至少 1 个，格式 `HH:mm`，支持多个
   - `startDate <= endDate`
   - `repeatType = daily | weekly`
     - `daily`：无需传 `repeatDays`（后端可按全周处理）
     - `weekly`：`repeatDays` 必须至少 1 个，取值 0–6（周日=0）

3. **计划详情页支持**：
   - 查看计划字段
   - 开关“微信提醒”（只是开关，不等于已授权；授权由订阅引导页完成）

---

### B) 今日用药打卡（`today-checkin`）

老人点击“已服用”，系统记录；漏服可补记或标记“未服”。

#### 产品行为

1. 进入“今日用药”，展示当天所有“应服点位”（由计划 × 日期 × 时间生成）
2. 每个点位有 3 种状态：
   - `todo`（待打卡）
   - `taken`（已服用）
   - `missed`（未服）
3. 点击“已服用/未服”立即落库并更新状态
4. 点“补记/更正”跳转至 `record-adjust`

> **关键决策**：  
> `records` 是“点位记录表”（不是日志流水），即：同一个 `plan + date + time` 只能有 1 条记录（便于统计是否按时服药）。

---

### C) 用药记录列表（`record-list`）

- 支持按：计划 / 状态 / 日期区间过滤
- 记录展示字段：
  - 计划名
  - 计划时间点
  - 状态
  - 实际操作时间
  - 备注
- 每条记录可进入“补记/更正”

---

### D) 补记/更正（`record-adjust`）

- 可将任意 record 的 `status` 改为 `taken` / `missed`
- 可填写 `actionAt`（实际操作时间）和 `note`（备注）
- **典型场景**：老人忘记打卡，家属或老人后补一条“已服用”

---

### E) 微信订阅消息提醒（`subscribe-guide`）

到点推送微信订阅消息（需首次授权），例如：“该吃降压药啦！”

#### 机制拆分（必须这样定，否则实现会混乱）

- **小程序侧**：
  - 只做“拉起订阅授权 + 上报授权结果”
- **后端侧**：
  - 根据 `plans` / `records` 定时触发发送订阅消息

#### 提醒开关的语义

- `plan.remindEnabled = true`：表示该计划允许提醒（用户层开关）
- “订阅授权 `granted = true`”：表示该用户对模板消息授权过（渠道层授权）
- **发送条件**（同时满足）：
  - `remindEnabled = true`
  - `granted = true`
  - `record.status = todo`
  - `now == record.time`

---

### F) 药品清单与说明（drug catalog）

- 内置常见药品数据库
- 点击可查看通俗说明（非医疗建议，仅参考）
- **前端当前还没有对应页面**，但接口 / 数据结构需先定义好

---

## 1.2 其他模块（第二阶段：先定需求+接口，后续加页面）

### 健康日记（手动记录）

- 每日自评：
  - 睡眠质量（好 / 一般 / 差）
  - 精神状态
  - 是否头晕 / 胸闷等
- 手动录入指标：
  - 血压（高 / 低）
  - 血糖
  - 心率
  - 体重
- 日历展示记录情况
- 周 / 月趋势折线图（前端绘制）

---

### AI 健康对话助手

- 支持文本 / 语音提问
- 常见问题快捷入口
- 规避医疗建议，提示“请咨询医生”
- 上下文记忆最近 3 轮
- 语音功能：
  - 录音：`wx.startRecord`
  - 语音识别：`wx.translateVoice`
  - TTS 播报

---

### 紧急联系人一键呼叫

- 设置 1~2 位紧急联系人
- 主页显眼按钮
- 点击直接拨号：`wx.makePhoneCall`

---

### 健康文章

- 内置适老化文章库
- 支持分类、详情页

---

### 家属远程查看（可选绑定）

- 老人生成“家庭码”，家属扫码绑定（手机号 / openid）
- 家属端可查看：
  - 用药打卡
  - 健康日记摘要
  - AI 对话历史
- **仅展示老人授权的内容**