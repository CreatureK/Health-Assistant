# 接口规范文档

## 2.1 通用约定

### 认证
1. 采用 **Bearer Token**（`request.js` 已带 `Authorization: Bearer <token>` 的写法）。
2. 除 `/api/v1/auth/captcha`  `/api/v1/auth/login`  `/api/v1/auth/register`外，其余接口都需要登录。

### 统一响应格式
- **成功**：
  ```json
  { "code": 200, "msg": "ok", "data": <payload> }
  ```
- **失败**：
  ```json
  { "code": 非200, "msg": "错误原因", "data": null }
  ```

### 建议错误码（后端实现时固定）
| 错误码 | 含义 |
|--------|------|
| 400 | 参数错误 |
| 401 | 未登录 / Token 失效 |
| 403 | 无权限（如家属访问未授权内容） |
| 404 | 资源不存在 |
| 409 | 冲突（如重复创建 record 点位） |
| 500 | 服务器错误 |

---

## 2.2 登录模块（已在 `api.js`）

### 1) 获取验证码
- **请求**：`GET /api/v1/auth/captcha`
- **响应 `data`**：
  ```json
  {
    "captchaId": "xxx",
    "imageBase64": "data:image/png;base64,...",
    "expireIn": 120
  }
  ```

### 2) 登录
- **请求**：`POST /api/v1/auth/login`
- **Body**：
  ```json
  {
    "username": "",
    "password": "",
    "captchaId": "",
    "captchaCode": ""
  }
  ```
- **响应 `data`**：
  ```json
  {
    "token": "jwt...",
    "user": {
      "id": 1,
      "nickname": "",
      "role": "elder"
    }
  }
  ```
### 3) 用户注册

- **请求方式**：`POST`
- **接口路径**：`/api/v1/auth/register`
- **请求体（Body）**：
  ```json
  {
    "username": "string",
    "password": "string",
    "captchaId": "string",
    "captchaCode": "string"
  }
  ```
- **成功响应（`data`）**：
  ```json
  {
    "id": 1
  }
  ```


## 2.3 用药管理（与 `api.js` 完全对齐）

### 数据结构：`MedPlan`
```json
{
  "id": 1,
  "name": "降压药",
  "dosage": "1片",
  "times": ["08:00", "20:00"],
  "startDate": "2025-12-18",
  "endDate": "2026-01-18",
  "repeatType": "daily",
  "repeatDays": [1,2,3,4,5,6,0],
  "remindEnabled": true,
  "createdAt": "2025-12-18 10:00:00",
  "updatedAt": "2025-12-18 10:00:00"
}
```

### 接口列表

1. **计划列表**  
   - `GET /api/v1/med/plans`  
   - Query（可选）：`status=active|expired`、`keyword=...`  
   - Response `data`: `[MedPlan, ...]`

2. **新建计划**  
   - `POST /api/v1/med/plans`  
   - Body（同 `MedPlan`，去掉 `id` 和时间字段）：
     ```json
     {
       "name": "降压药",
       "dosage": "1片",
       "times": ["08:00"],
       "startDate": "2025-12-18",
       "endDate": "2025-12-31",
       "repeatType": "weekly",
       "repeatDays": [1,3,5],
       "remindEnabled": false
     }
     ```
   - Response `data`: `{ "id": 123 }`

3. **计划详情**  
   - `GET /api/v1/med/plans/:id`  
   - Response `data`: `MedPlan`

4. **更新计划**  
   - `PUT /api/v1/med/plans/:id`  
   - **规则**：若计划被修改，只重建 `today+1` 之后的点位；已发生的记录不改。

5. **删除计划**  
   - `DELETE /api/v1/med/plans/:id`  
   - **建议**：后端做软删，或级联删除未来 todo records。

---

## 2.4 今日用药（`today-checkin`）

### 数据结构：`MedRecord`（点位记录）
```json
{
  "id": 9001,
  "planId": 123,
  "planName": "降压药",
  "dosage": "1片",
  "date": "2025-12-18",
  "time": "08:00",
  "status": "todo",
  "actionAt": null,
  "note": null
}
```

### 接口列表

1. **获取当天点位**  
   - `GET /api/v1/med/today?date=2025-12-18`  
   - Response `data`:
     ```json
     {
       "date": "2025-12-18",
       "list": [MedRecord, ...]
     }
     ```

2. **确保生成点位（强烈建议）**  
   - `POST /api/v1/med/today/ensure`  
   - Body: `{ "date": "2025-12-18" }`  
   - 作用：按计划生成 records（`plan × time × date`）并去重。

---

## 2.5 记录操作（`record-list` / `record-adjust`）

1. **标记已服用/未服**  
   - `POST /api/v1/med/records/:recordId/mark`  
   - Body: `{ "status": "taken" }` // `taken` | `missed`  
   - 规则：
     - `actionAt` 默认写入当前时间
     - 允许从 `taken/missed` 改回，但需记录 `updatedAt`

2. **补记/更正**  
   - `POST /api/v1/med/records/:recordId/adjust`  
   - Body:
     ```json
     {
       "status": "taken",
       "actionAt": "2025-12-18 08:10:00",
       "note": "忘记打卡，补记"
     }
     ```

3. **查询记录**  
   - `GET /api/v1/med/records`  
   - Query: `planId?`, `status?`, `startDate?`, `endDate?`, `id?`  
   - Response `data`:
     ```json
     {
       "list": [MedRecord, ...],
       "page": 1,
       "size": 20,
       "total": 120
     }
     ```

---

## 2.6 药品库（SDG3 要求，`api.js` 尚未添加）

### 建议新增接口：

1. **药品搜索列表**  
   - `GET /api/v1/med/drugs`  
   - Query: `keyword?`, `page?`, `size?`  
   - Response `data`:
     ```json
     {
       "list": [
         { "id": 1, "name": "阿司匹林", "tags": ["抗血小板"] }
       ],
       "page": 1,
       "size": 20,
       "total": 50
     }
     ```

2. **药品详情（通俗说明 + 免责声明）**  
   - `GET /api/v1/med/drugs/:id`  
   - Response `data`:
     ```json
     {
       "id": 1,
       "name": "阿司匹林",
       "commonNames": ["拜阿司匹林"],
       "intro": "通俗说明...",
       "usage": "一般如何使用（非处方建议，仅科普）",
       "warnings": "注意事项...",
       "disclaimer": "非医疗建议，仅参考，如有不适请咨询医生"
     }
     ```

---

## 3. 第二阶段模块接口（先定好，后续直接开发）

这些来自 SDG3 的 2~6 点：AI 对话、紧急联系人、文章、家属绑定。

### 3.1 AI 对话

- `POST /api/v1/ai/chat`  
  Body: `{ "sessionId?": "...", "message": "...", "inputType": "text|voice" }`  
  Response:
  ```json
  {
    "sessionId": "...",
    "replyText": "...",
    "safetyHint": "...",
    "messages": [最近3轮]
  }
  ```

- `GET /api/v1/ai/sessions`
- `GET /api/v1/ai/sessions/:id/messages`

### 3.2 紧急联系人

- `GET /api/v1/profile/emergency-contacts`
- `PUT /api/v1/profile/emergency-contacts`  
  Body: `{ "contacts": [{ "name": "...", "phone": "..." }] }`（限制 1~2 条）

### 3.3 健康文章

#### 数据结构：`ArticleVO`（列表项）
```json
{
  "id": 1,
  "title": "如何科学养生",
  "category": "养生保健",
  "desc": "文章摘要（前100字符）...",
  "coverImage": "https://example.com/cover.jpg",
  "viewCount": 123,
  "createdAt": "2025-12-18 10:00:00"
}
```

#### 数据结构：`ArticleDetailVO`（详情）
```json
{
  "id": 1,
  "title": "如何科学养生",
  "category": "养生保健",
  "content": "完整文章内容...",
  "coverImage": "https://example.com/cover.jpg",
  "viewCount": 124,
  "createdAt": "2025-12-18 10:00:00",
  "updatedAt": "2025-12-18 10:00:00"
}
```

#### 接口列表

1. **文章列表**  
   - `GET /api/v1/articles`  
   - Query（可选）：
     - `category`: 分类（可选值：养生保健、慢病管理、运动与康复、心理健康与社交）
     - `keyword`: 关键词（用于搜索标题和内容）
     - `page`: 页码（默认为1）
     - `size`: 每页大小（默认为20）
   - Response `data`:
     ```json
     {
       "list": [ArticleVO, ...],
       "page": 1,
       "size": 20,
       "total": 100
     }
     ```

2. **文章详情**  
   - `GET /api/v1/articles/:id`  
   - 说明：访问时自动增加浏览次数
   - Response `data`: `ArticleDetailVO`
   - 错误响应：文章不存在时返回 `{ "code": 404, "msg": "资源不存在", "data": null }`

### 3.4 家属绑定与授权查看

- `POST /api/v1/family/code`（老人生成家庭码）  
  Response: `{ "code": "...", "expireAt": "..." }`

- `POST /api/v1/family/bind`（家属绑定）  
  Body: `{ "code": "..." }`

- `GET /api/v1/family/overview`（家属侧聚合：用药打卡、对话历史）

- **权限规则**：只返回老人授权内容

---

## 4. 执行安排

按“删原型 → 定需求 → 定接口 → 设库 → 开发”推进：

1. **需求定稿**：以本文件第 1 部分为 PRD（MVP = 用药管理闭环）
2. **接口定稿**：以第 2 部分为后端接口契约（返回格式必须 `{code, msg, data}`）
3. **数据库设计**：后端按以下建表：
   - `Plan`
   - `PlanTimes`
   - `Records`（点位）
   - `DrugCatalog`
   - （第二阶段表后续补充）

4. **开发顺序建议**：
   - **31.a**：先把 `/med/plans`、`/med/today`、`/med/records` 跑通（前端页面已齐）